<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Full TOEFL iBT Practice Test</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
        }
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .timer {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px;
            background: var(--primary);
            color: white;
            border-radius: 5px;
        }
        button {
            background: var(--secondary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        textarea, .question {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="timer" id="timer">Time: 00:00</div>
    
    <!-- Reading Section -->
    <div class="section" id="reading">
        <h2>üìñ Reading</h2>
        <div class="question">
            <p>Sample passage text here...</p>
            <select id="reading-answer">
                <option value="A">Answer A</option>
                <option value="B">Answer B</option>
            </select>
        </div>
        <button onclick="submitReading()">Submit</button>
        <div id="reading-result"></div>
    </div>

    <!-- Listening Section -->
    <div class="section hidden" id="listening">
        <h2>üéß Listening</h2>
        <audio controls id="audioPlayer">
            <source src="dummy.mp3" type="audio/mpeg">
        </audio>
        <div class="question">
            <select id="listening-answer">
                <option value="A">Answer A</option>
                <option value="B">Answer B</option>
            </select>
        </div>
        <button onclick="submitListening()">Submit</button>
        <div id="listening-result"></div>
    </div>

    <!-- Speaking Section -->
    <div class="section hidden" id="speaking">
        <h2>üé§ Speaking</h2>
        <p>Prompt: Describe your favorite city...</p>
        <button id="recordBtn" onclick="toggleRecording()">Start Recording</button>
        <div id="speaking-result"></div>
    </div>

    <!-- Writing Section -->
    <div class="section hidden" id="writing">
        <h2>‚úçÔ∏è Writing</h2>
        <p>Prompt: Do you agree that...?</p>
        <textarea id="essay" rows="10"></textarea>
        <button onclick="submitWriting()">Submit</button>
        <div id="writing-result"></div>
    </div>

    <script>
        // Configuration
        const DEEPSEEK_API_KEY = 'f2eefecc137b4f048c15cd04f1b81f5b';
        let currentSection = 0;
        let recorder, audioChunks = [];
        const sections = ['reading', 'listening', 'speaking', 'writing'];
        const correctAnswers = { reading: 'B', listening: 'A' };
        
        // Section Navigation
        function showSection(sectionIndex) {
            sections.forEach((s, i) => {
                document.getElementById(s).classList.toggle('hidden', i !== sectionIndex);
            });
            currentSection = sectionIndex;
        }

        // Timer System
        let examTimer;
        function startTimer(minutes) {
            let time = minutes * 60;
            examTimer = setInterval(() => {
                const mins = Math.floor(time / 60);
                const secs = time % 60;
                document.getElementById('timer').textContent = 
                    `Time: ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                if (time-- <= 0) autoSubmit();
            }, 1000);
        }

        // Speaking Section
        async function toggleRecording() {
            if (!recorder) {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream);
                audioChunks = [];
                
                recorder.ondataavailable = e => audioChunks.push(e.data);
                recorder.start();
                document.getElementById('recordBtn').textContent = 'Stop Recording';
            } else {
                recorder.stop();
                recorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks);
                    const transcript = await convertSpeechToText(audioBlob);
                    evaluateResponse('speaking', transcript);
                };
                recorder = null;
                document.getElementById('recordBtn').textContent = 'Start Recording';
            }
        }

        async function convertSpeechToText(audioBlob) {
            // Using browser's built-in Web Speech API
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            
            return new Promise((resolve) => {
                recognition.onresult = (event) => {
                    resolve(event.results[0][0].transcript);
                };
                recognition.start();
            });
        }

        // Evaluation System
        async function evaluateResponse(section, content) {
            const promptMap = {
                writing: "Evaluate this TOEFL essay (0-30) considering grammar, vocabulary, and coherence:",
                speaking: "Evaluate this TOEFL speaking response (0-30) considering pronunciation, fluency, and content:"
            };

            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{
                        role: "user",
                        content: `${promptMap[section]} ${content}`
                    }]
                })
            });

            const data = await response.json();
            const result = data.choices[0].message.content;
            document.getElementById(`${section}-result`).innerHTML = 
                `<h3>Score: ${extractScore(result)}/30</h3><p>${result}</p>`;
            showSection(currentSection + 1);
        }

        function extractScore(text) {
            const match = text.match(/\b\d{1,2}\b/);
            return match ? match[0] : 'N/A';
        }

        // Section Handlers
        function submitReading() {
            const answer = document.getElementById('reading-answer').value;
            const result = answer === correctAnswers.reading ? 'Correct (1/1)' : 'Incorrect (0/1)';
            document.getElementById('reading-result').textContent = result;
            showSection(1);
        }

        function submitListening() {
            const answer = document.getElementById('listening-answer').value;
            const result = answer === correctAnswers.listening ? 'Correct (1/1)' : 'Incorrect (0/1)';
            document.getElementById('listening-result').textContent = result;
            showSection(2);
        }

        function submitWriting() {
            const essay = document.getElementById('essay').value;
            evaluateResponse('writing', essay);
        }

        // Initialize Test
        startTimer(120); // 2-hour timer
        showSection(0);
    </script>
</body>
</html>
